<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <title>B.O.S. v1</title>
 <style>
   /* ... (keep existing styles) ... */
   .warning { color: #ffc107; font-weight: bold; }
 </style>
</head>
<body>
 <!-- ... (keep existing HTML structure) ... -->


 <script>
   document.addEventListener('DOMContentLoaded', () => {
     // ... (keep existing DOM references) ...


     // ‚Äî‚Äî Enhanced error handling ‚Äî‚Äî
     function handleApiError(error, serviceName) {
       console.error(`${serviceName} Error:`, error);
       const message = error.message.includes('500')
         ? `Service temporary unavailable (${serviceName}). Please try later.`
         : error.message;
       addMessage('System', message, true);
     }


     // ‚Äî‚Äî Updated TTS handling ‚Äî‚Äî
     async function handleTTS(reply) {
       try {
         const res = await fetch('/api/speak', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ text: reply })
         });


         if (!res.ok) {
           const error = await res.json();
           throw new Error(error.message || `TTS failed: HTTP ${res.status}`);
         }
        
         const { url } = await res.json();
         if (!url) throw new Error('Received empty audio URL');


         ttsPlayer.src = url;
         ttsPlayer.style.display = 'block';
        
         await new Promise((resolve, reject) => {
           ttsPlayer.addEventListener('canplaythrough', resolve);
           ttsPlayer.addEventListener('error', () => reject(new Error('Audio playback failed')));
         });
        
         await ttsPlayer.play();
       } catch (err) {
         handleApiError(err, 'TTS Service');
       }
     }


     // ‚Äî‚Äî Updated recording handling ‚Äî‚Äî
     async function startRecording() {
       try {
         const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
           .catch(err => {
             if (err.name === 'NotAllowedError') {
               throw new Error('Microphone access blocked. Please enable permissions in browser settings.');
             }
             throw err;
           });


         const mediaRecorder = new MediaRecorder(stream);
         const audioChunks = [];


         mediaRecorder.ondataavailable = e => audioChunks.push(e.data);


         mediaRecorder.onstop = async () => {
           try {
             const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
             stream.getTracks().forEach(track => track.stop());


             const form = new FormData();
             form.append('file', blob, 'recording');
             const res = await fetch('/api/transcribe', { method: 'POST', body: form });


             if (!res.ok) {
               const error = await res.json();
               throw new Error(error.message || `Transcription failed: HTTP ${res.status}`);
             }


             const { text } = await res.json();
             addMessage('You', text);
             userInput.value = text;
           } catch (err) {
             handleApiError(err, 'Transcription Service');
           }
         };


         mediaRecorder.start();
         return mediaRecorder;
       } catch (err) {
         handleApiError(err, 'Recording');
         throw err;
       }
     }


     // ‚Äî‚Äî Updated record button handler ‚Äî‚Äî
     let activeRecorder = null;
     recordBtn.addEventListener('click', async () => {
       if (!activeRecorder) {
         try {
           recordBtn.disabled = true;
           addMessage('System', 'Preparing recording...', false);
          
           activeRecorder = await startRecording();
           recordBtn.textContent = '‚èπÔ∏è Stop Recording';
           addMessage('System', 'Recording started - speak now', false);
         } catch {
           recordBtn.textContent = 'üé§ Record';
         } finally {
           recordBtn.disabled = false;
         }
       } else {
         activeRecorder.stop();
         activeRecorder = null;
         recordBtn.textContent = 'üé§ Record';
         addMessage('System', 'Recording stopped - processing...', false);
       }
     });


     // ... (keep sendMessage and other functions) ...
   });
 </script>
</body>
</html>


